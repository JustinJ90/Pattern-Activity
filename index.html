<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pattern Master Class</title>
    <style>
        /* --- Í∏∞Î≥∏ ÏÑ§Ï†ï --- */
        body {
            font-family: 'Pretendard', 'Malgun Gothic', sans-serif;
            background-color: #f0f2f5; margin: 0; padding: 0;
            height: 100vh; display: flex; flex-direction: column;
            overflow: hidden; user-select: none; -webkit-user-select: none;
        }

        /* --- Ìó§Îçî --- */
        header {
            background-color: #2c3e50; padding: 10px 20px;
            display: flex; align-items: center; justify-content: space-between;
            height: 60px; flex-shrink: 0; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 100;
        }
        .logo { font-size: 18px; font-weight: bold; color: #ecf0f1; display: flex; align-items: center; gap: 8px; }
        .menu-group { display: flex; gap: 8px; align-items: center; }

        select {
            background-color: #34495e; color: white; border: 1px solid #5d6d7e;
            padding: 8px 10px; border-radius: 8px; font-size: 14px;
            outline: none; font-weight: bold; cursor: pointer;
            width: auto; max-width: 300px; min-width: 100px;
            text-overflow: ellipsis; white-space: nowrap; overflow: hidden;
            transition: width 0.2s ease;
        }

        /* --- Î©îÏù∏ Ïä§ÌÖåÏù¥ÏßÄ --- */
        .stage {
            flex: 1; display: flex; justify-content: center; align-items: center;
            position: relative; padding: 20px; width: 100%; box-sizing: border-box;
        }
        .card {
            background: white; width: 100%; max-width: 900px; height: 100%; max-height: 600px;
            border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; overflow: hidden; position: relative;
        }

        /* --- Í≥µÌÜµ ÏßàÎ¨∏ ÏòÅÏó≠ --- */
        .q-area { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; text-align: center; }
        .q-text { font-size: 32px; font-weight: 800; color: #2c3e50; margin-bottom: 20px; word-break: keep-all; }
        .q-sub { font-size: 18px; color: #7f8c8d; margin-bottom: 15px; font-weight: bold; }
        .q-image { max-width: 100%; max-height: 250px; object-fit: contain; border-radius: 10px; display: none; margin-bottom: 15px; }
        .q-emoji { font-size: 100px; line-height: 1; display: none; margin-bottom: 15px; animation: pop 0.3s; }

        /* --- Ï†ïÎãµ Î∞ïÏä§ (Look & Say, Blanks, Speed Ïö©) --- */
        .answer-area { 
            height: 100px; background: #fafafa; display: flex; justify-content: center; align-items: center; padding: 20px; 
        }
        .answer-box {
            width: 90%; height: 60px; border-radius: 12px; font-weight: bold; font-size: 22px;
            cursor: pointer; display: flex; justify-content: center; align-items: center; text-align: center;
            background-color: white; color: #95a5a6; border: 2px dashed #bdc3c7; transition: all 0.3s;
        }
        .answer-box.visible {
            background-color: #3498db; color: white; border: 2px solid #3498db;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4); transform: translateY(-3px); font-size: 26px;
        }

        /* --- [Mode 2 & 3] Unscramble & Dictation Block --- */
        .us-slot { flex: 1; background: #f0f4f8; border-radius: 10px; margin: 10px; padding: 10px; display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 8px; border: 2px solid #dce4ec;}
        .us-slot.correct { background: #e3f9e5; border-color: #2ecc71; }
        .us-pool { min-height: 100px; background: white; padding: 10px; display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; border-top: 1px solid #eee; }
        
        .word-block { background: white; border: 2px solid #3498db; color: #2c3e50; padding: 6px 14px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 18px; }
        .word-block:active { transform: scale(0.95); }
        .us-slot .word-block { background: #3498db; color: white; }

        /* --- [Mode 3] Dictation Button --- */
        .listen-btn {
            background: #f1c40f; color: #2c3e50; border: none; padding: 15px 30px; border-radius: 50px;
            font-size: 24px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s; display: flex; align-items: center; gap: 10px;
        }
        .listen-btn:active { transform: scale(0.95); }
        .listen-btn:hover { background: #f39c12; color: white; }

        /* --- [Mode 4] Pattern Blanks --- */
        .blank-text { font-size: 32px; font-weight: bold; color: #2c3e50; line-height: 1.6; }
        
        /* --- [Mode 5] Speed Game --- */
        .timer-bar-bg { position: absolute; top: 0; left: 0; width: 100%; height: 8px; background: #eee; }
        .timer-bar { height: 100%; background: #e74c3c; width: 100%; transition: width 1s linear; }
        
        /* ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò */
        .nav-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.8); border: 1px solid #ddd; width: 60px; height: 60px; border-radius: 50%; font-size: 28px; cursor: pointer; color: #2c3e50; z-index: 20; display: flex; justify-content: center; align-items: center; }
        .nav-prev { left: 10px; } .nav-next { right: 10px; }
        .progress-bar { position: absolute; bottom: 15px; font-size: 14px; color: #95a5a6; font-weight: bold; left: 50%; transform: translateX(-50%); }

        /* Ïú†Ìã∏ */
        .hidden { display: none !important; }
        @keyframes pop { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        @media (max-width: 768px) {
            .q-text { font-size: 24px; }
            .word-block { font-size: 16px; padding: 5px 10px; }
            .card { height: 100%; border-radius: 0; } 
            .stage { padding: 0; } .logo span { display: none; }
        }
    </style>
</head>
<body>

<header>
    <div class="logo">üéì <span>Pattern Master</span></div>
    <div class="menu-group">
        <select id="bookSel" onchange="updatePatterns(); resizeSelect(this)"></select>
        <select id="patSel" onchange="resetActivity(); resizeSelect(this)"></select>
        <select id="actSel" onchange="resetActivity(); resizeSelect(this)">
            <option value="looksay">1. Look & Say</option>
            <option value="unscramble">2. Unscramble</option>
            <option value="dictation">3. Block Dictation</option>
            <option value="blanks">4. Pattern Blanks</option>
            <option value="speed">5. Speed Game</option>
        </select>
    </div>
</header>

<div class="stage" id="touchStage">
    <button class="nav-btn nav-prev" onclick="prevSlide()">‚ùÆ</button>
    <button class="nav-btn nav-next" onclick="nextSlide()">‚ùØ</button>

    <div class="card">
        
        <div id="speedTimerArea" class="timer-bar-bg hidden"><div id="timerBar" class="timer-bar"></div></div>

        <div class="q-area">
            <img id="qImg" class="q-image" src="" alt="Image">
            <div id="qEmoji" class="q-emoji"></div>
            
            <div id="qText" class="q-text">Loading...</div>

            <div id="blankText" class="blank-text hidden"></div>

            <div id="dicArea" class="hidden">
                <button class="listen-btn" onclick="speakText()">üîä Tap to Listen</button>
            </div>
        </div>

        <div id="usArea" class="hidden" style="flex:1; flex-direction:column; width:100%;">
            <div id="usSlot" class="us-slot"></div>
            <div id="usPool" class="us-pool"></div>
        </div>

        <div id="commonAnswerArea" class="answer-area">
            <div class="answer-box" id="aBox" onclick="toggleAnswer()">
                üëÜ Tap to check answer
            </div>
        </div>
    </div>

    <div class="progress-bar" id="progress">1 / 10</div>
</div>

<script src="data.js"></script>
<script>
    // --- Ïú†Ìã∏Î¶¨Ìã∞ ---
    function resizeSelect(sel) {
        let tempSpan = document.createElement("span");
        tempSpan.style.visibility = "hidden"; tempSpan.style.position = "absolute"; 
        tempSpan.style.fontSize = "14px"; tempSpan.style.fontWeight = "bold"; tempSpan.innerText = sel.options[sel.selectedIndex].text;
        document.body.appendChild(tempSpan);
        sel.style.width = (tempSpan.offsetWidth + 45) + "px";
        document.body.removeChild(tempSpan);
    }

    // --- Ï†ÑÏó≠ Î≥ÄÏàò ---
    let currentItems = [];
    let currentIndex = 0;
    let currentMode = "looksay";
    let timerInterval = null; 
    let unscrambleState = { target: "", selected: [] };

    window.onload = function() {
        if (typeof bookData === 'undefined') { alert("data.js ÏóÜÏùå"); return; }
        initBookMenu();
        initTouchEvents();
        resizeSelect(document.getElementById('actSel'));
    };

    function initBookMenu() {
        const bookSel = document.getElementById('bookSel');
        Object.keys(bookData).forEach(book => bookSel.innerHTML += `<option value="${book}">${book}</option>`);
        updatePatterns(); resizeSelect(bookSel);
    }

    function updatePatterns() {
        const bookName = document.getElementById('bookSel').value;
        const patSel = document.getElementById('patSel');
        const items = bookData[bookName];
        const pSet = new Set(items.map(d => d["Pattern #"]));
        patSel.innerHTML = "";
        pSet.forEach(p => {
            const name = items.find(d => d["Pattern #"] == p)["Pattern Name"];
            patSel.innerHTML += `<option value="${p}">${p}. ${name}</option>`;
        });
        resizeSelect(patSel);
        resetActivity();
    }

    function resetActivity() {
        const bookName = document.getElementById('bookSel').value;
        const pNum = parseInt(document.getElementById('patSel').value);
        currentMode = document.getElementById('actSel').value;
        
        const allItems = bookData[bookName].filter(d => d["Pattern #"] === pNum);
        
        // Îç∞Ïù¥ÌÑ∞ ÌïÑÌÑ∞ÎßÅ: Unscramble, DictationÏùÄ Unscramble Îç∞Ïù¥ÌÑ∞ Ïö∞ÏÑ†
        if (currentMode === 'unscramble' || currentMode === 'dictation') {
            currentItems = allItems.filter(d => d.Section === "Unscramble");
            if (!currentItems.length) currentItems = allItems.filter(d => d.Section === "Speaking II");
        } else {
            currentItems = allItems.filter(d => d.Section === "Speaking II");
            if (!currentItems.length) currentItems = allItems.filter(d => d.Section === "Unscramble");
        }

        currentIndex = 0;
        clearInterval(timerInterval);
        renderSlide();
    }

    function renderSlide() {
        if (currentItems.length === 0) return;
        const item = currentItems[currentIndex];
        
        const els = {
            qText: document.getElementById('qText'),
            qImg: document.getElementById('qImg'),
            qEmoji: document.getElementById('qEmoji'),
            blankText: document.getElementById('blankText'),
            dicArea: document.getElementById('dicArea'),
            usArea: document.getElementById('usArea'),
            timerArea: document.getElementById('speedTimerArea'),
            ansArea: document.getElementById('commonAnswerArea'),
            aBox: document.getElementById('aBox'),
            progress: document.getElementById('progress')
        };

        // Ï¥àÍ∏∞Ìôî
        els.qText.classList.add('hidden');
        els.qImg.classList.add('hidden');
        els.qEmoji.classList.add('hidden');
        els.blankText.classList.add('hidden');
        els.dicArea.classList.add('hidden');
        els.usArea.classList.add('hidden');
        els.timerArea.classList.add('hidden');
        els.ansArea.classList.remove('hidden');

        els.aBox.className = "answer-box";
        els.aBox.innerText = "üëÜ Tap to check answer";
        els.progress.innerText = `${currentIndex + 1} / ${currentItems.length}`;

        // Ïù¥ÎØ∏ÏßÄ Ï≤òÎ¶¨
        let hasImage = false;
        if (item["Image"] && item["Image"].trim() !== "") {
            const val = item["Image"].trim();
            if (val.includes('.') || val.includes('/')) {
                els.qImg.src = "images/" + val; els.qImg.classList.remove('hidden');
            } else {
                els.qEmoji.innerText = val; els.qEmoji.classList.remove('hidden');
            }
            hasImage = true;
        }

        switch(currentMode) {
            case 'looksay':
                if (!hasImage) { els.qText.innerText = item["Korean/Question"]; els.qText.classList.remove('hidden'); }
                break;
            
            case 'unscramble':
                // ÌïúÍ∏Ä Î¨∏Ï†ú Î≥¥ÏûÑ + Î∏îÎ°ù ÎßûÏ∂îÍ∏∞
                els.qText.innerText = item["Korean/Question"]; els.qText.classList.remove('hidden');
                els.usArea.classList.remove('hidden');
                els.ansArea.classList.add('hidden');
                initUnscramble(item);
                break;

            case 'dictation':
                // ÌïúÍ∏Ä/Ïù¥ÎØ∏ÏßÄ Î™®Îëê Ïà®ÍπÄ + Îì£Í∏∞ Î≤ÑÌäº + Î∏îÎ°ù ÎßûÏ∂îÍ∏∞
                els.qImg.classList.add('hidden'); // Ïù¥ÎØ∏ÏßÄÎèÑ Í∞ÄÎ¶º (ÏÜåÎ¶¨Ïóê ÏßëÏ§ë)
                els.qEmoji.classList.add('hidden');
                els.dicArea.classList.remove('hidden');
                els.usArea.classList.remove('hidden');
                els.ansArea.classList.add('hidden');
                initUnscramble(item); // Î∏îÎ°ù Î°úÏßÅÏùÄ ÎèôÏùº
                break;

            case 'blanks':
                els.qText.innerText = item["Korean/Question"]; els.qText.classList.remove('hidden');
                els.blankText.classList.remove('hidden');
                let patName = item["Pattern Name"].replace(/[\.\~\?\[\]]/g, "").trim(); 
                let sentence = item["English/Answer"];
                let regex = new RegExp(patName, "i");
                let masked = sentence.replace(regex, "_______");
                if (masked === sentence) {
                    let parts = sentence.split(" ");
                    if(parts.length > 1) { parts[0] = "____"; parts[1] = "____"; masked = parts.join(" "); }
                }
                els.blankText.innerHTML = masked;
                break;

            case 'speed':
                if (!hasImage) { els.qText.innerText = item["Korean/Question"]; els.qText.classList.remove('hidden'); }
                els.timerArea.classList.remove('hidden');
                startTimer();
                break;
        }
    }

    // --- Î°úÏßÅ ---

    function toggleAnswer() {
        const item = currentItems[currentIndex];
        const aBox = document.getElementById('aBox');
        if (aBox.classList.contains('visible')) {
            aBox.classList.remove('visible'); aBox.innerText = "üëÜ Tap to check answer";
        } else {
            aBox.classList.add('visible'); aBox.innerText = item["English/Answer"];
            if(currentMode === 'speed') clearInterval(timerInterval);
        }
    }

    // [Unscramble & Dictation Block Logic]
    function initUnscramble(item) {
        const usSlot = document.getElementById('usSlot');
        const usPool = document.getElementById('usPool');
        usSlot.innerHTML = ""; usPool.innerHTML = ""; usSlot.className = "us-slot";
        
        unscrambleState.target = item["English/Answer"].replace(/[^a-zA-Z0-9]/g, "").toLowerCase();
        
        let raw = item["Scrambled"] || item["English/Answer"];
        let words = raw.includes("/") ? raw.split("/") : raw.split(" ");
        words = words.map(w=>w.trim()).sort(()=>Math.random()-0.5);

        words.forEach((w) => {
            let btn = document.createElement("div");
            btn.className = "word-block"; btn.innerText = w;
            btn.onclick = () => {
                btn.classList.add("hidden");
                let slotBtn = document.createElement("div");
                slotBtn.className = "word-block"; slotBtn.innerText = w;
                slotBtn.onclick = () => { slotBtn.remove(); btn.classList.remove("hidden"); checkUnscramble(); };
                usSlot.appendChild(slotBtn);
                checkUnscramble();
            };
            usPool.appendChild(btn);
        });
    }

    function checkUnscramble() {
        const currentWords = Array.from(document.querySelectorAll("#usSlot .word-block")).map(el=>el.innerText).join("");
        const currentClean = currentWords.replace(/[^a-zA-Z0-9]/g, "").toLowerCase();
        
        if (currentClean === unscrambleState.target && currentClean.length > 0) {
            document.getElementById('usSlot').classList.add("correct");
            if(navigator.vibrate) navigator.vibrate(50);
        } else {
            document.getElementById('usSlot').classList.remove("correct");
        }
    }

    // [Dictation TTS]
    function speakText() {
        const item = currentItems[currentIndex];
        const utterance = new SpeechSynthesisUtterance(item["English/Answer"]);
        utterance.lang = 'en-US'; utterance.rate = 0.9;
        window.speechSynthesis.speak(utterance);
    }

    // [Speed Game]
    function startTimer() {
        const bar = document.getElementById('timerBar');
        bar.style.transition = 'none'; bar.style.width = '100%';
        setTimeout(() => { bar.style.transition = 'width 5s linear'; bar.style.width = '0%'; }, 50);
        clearInterval(timerInterval);
        timerInterval = setTimeout(() => {
            const aBox = document.getElementById('aBox');
            if (!aBox.classList.contains('visible')) toggleAnswer();
        }, 5000);
    }

    // --- ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò ---
    function nextSlide() { if (currentIndex < currentItems.length - 1) { currentIndex++; renderSlide(); } }
    function prevSlide() { if (currentIndex > 0) { currentIndex--; renderSlide(); } }

    function initTouchEvents() {
        let ts = 0;
        const stage = document.getElementById('touchStage');
        stage.addEventListener('touchstart', e => { ts = e.changedTouches[0].screenX; }, {passive: true});
        stage.addEventListener('touchend', e => { 
            let te = e.changedTouches[0].screenX; 
            if (te < ts - 60) nextSlide(); if (te > ts + 60) prevSlide();
        }, {passive: true});
    }

    document.addEventListener('keydown', (e) => {
        if (e.key === "ArrowRight") nextSlide();
        if (e.key === "ArrowLeft") prevSlide();
        if (e.key === " ") toggleAnswer();
    });
</script>
</body>
</html>