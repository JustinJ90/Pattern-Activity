<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pattern Activity (Layout Fixed)</title>
    <style>
        /* --- ê¸°ë³¸ ì„¤ì • --- */
        body {
            font-family: 'Pretendard', 'Malgun Gothic', sans-serif;
            background-color: #f0f2f5;
            margin: 0; padding: 0;
            height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden;
            user-select: none; -webkit-user-select: none;
        }

        /* --- ìƒë‹¨ í—¤ë” --- */
        header {
            background-color: #2c3e50;
            padding: 10px 20px;
            display: flex; align-items: center; justify-content: space-between;
            height: 60px; flex-shrink: 0;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            z-index: 100;
        }
        .logo { font-size: 18px; font-weight: bold; color: #ecf0f1; display: flex; align-items: center; gap: 8px; }
        .menu-group { display: flex; gap: 8px; align-items: center; }

        select {
            background-color: #34495e; color: white; border: 1px solid #5d6d7e;
            padding: 8px 10px; border-radius: 8px; font-size: 14px;
            outline: none; font-weight: bold; cursor: pointer;
            width: auto; max-width: 400px; min-width: 100px;
            text-overflow: ellipsis; white-space: nowrap; overflow: hidden;
            transition: width 0.2s ease;
        }

        /* --- ë©”ì¸ ìŠ¤í…Œì´ì§€ --- */
        .stage {
            flex: 1; display: flex; justify-content: center; align-items: center;
            position: relative; padding: 20px; width: 100%; box-sizing: border-box;
        }
        .card {
            background: white; width: 100%; max-width: 900px; height: 100%; max-height: 600px;
            border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex; flex-direction: column;
            position: relative; overflow: hidden;
        }

        /* === 1. Look & Say ë ˆì´ì•„ì›ƒ (2/3 + 1/3) === */
        #lookSayContainer {
            display: flex; flex-direction: column; height: 100%; width: 100%;
        }
        /* ìƒë‹¨ 2/3: ë¬¸ì œ ì˜ì—­ */
        .ls-upper {
            flex: 2; /* 2/3 ë¹„ìœ¨ */
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 20px; border-bottom: 1px solid #f0f0f0;
            overflow: hidden;
        }
        /* í•˜ë‹¨ 1/3: ì •ë‹µ ë°•ìŠ¤ ì˜ì—­ */
        .ls-lower {
            flex: 1; /* 1/3 ë¹„ìœ¨ */
            display: flex; justify-content: center; align-items: center;
            padding: 20px; background-color: #fafafa;
        }

        /* ìš”ì†Œ ìŠ¤íƒ€ì¼ */
        .q-text { font-size: 36px; font-weight: 800; color: #2c3e50; line-height: 1.4; word-break: keep-all; text-align: center;}
        .q-image { max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 10px; display: none; }
        .q-emoji { font-size: 140px; line-height: 1; display: none; animation: pop 0.3s; }
        
        .answer-box {
            width: 90%; height: 70%; 
            border-radius: 15px; font-weight: bold; font-size: 24px;
            cursor: pointer; transition: all 0.3s; display: flex; justify-content: center; align-items: center;
            text-align: center;
            background-color: white; color: #95a5a6; border: 2px dashed #bdc3c7;
        }
        .answer-box.visible {
            background-color: #3498db; color: white; border: 2px solid #3498db;
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.4); transform: translateY(-5px);
        }

        /* === 2. Unscramble ë ˆì´ì•„ì›ƒ (3ë¶„í• ) === */
        #unscrambleContainer {
            display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
            flex-direction: column; height: 100%; width: 100%;
        }
        /* ìƒë‹¨: ì§ˆë¬¸ */
        .us-top {
            flex: 1; /* ìƒë‹¨ */
            display: flex; justify-content: center; align-items: center;
            padding: 10px 20px; border-bottom: 1px solid #eee;
        }
        .us-top .q-text { font-size: 28px; } /* ê¸€ì”¨ ì¡°ê¸ˆ ì‘ê²Œ */

        /* ì¤‘ë‹¨: ì •ë‹µ ìŠ¬ë¡¯ */
        .us-mid {
            flex: 1.2; /* ì¤‘ê°„ (ì¡°ê¸ˆ ë” ë„“ê²Œ) */
            background: #f0f4f8; 
            padding: 20px; 
            display: flex; flex-wrap: wrap; align-content: center; justify-content: center; gap: 8px;
            overflow-y: auto;
            transition: background 0.3s;
        }
        .us-mid.correct { background: #e3f9e5; box-shadow: inset 0 0 20px rgba(46, 204, 113, 0.2); }

        /* í•˜ë‹¨: ë‹¨ì–´ ë¸”ë¡ í’€ */
        .us-bot {
            flex: 1; /* í•˜ë‹¨ */
            padding: 20px; 
            display: flex; flex-wrap: wrap; justify-content: center; align-content: center; gap: 10px;
            background: white;
            border-top: 1px solid #eee;
        }

        /* â˜… ë‹¨ì–´ ë¸”ë¡ ìŠ¤íƒ€ì¼ ê°œì„  â˜… */
        .word-block {
            background: white; border: 2px solid #3498db; color: #2c3e50;
            padding: 8px 16px; /* í¬ê¸° ì¶•ì†Œ */
            border-radius: 8px; /* ë‘¥ê·¼ ì‚¬ê°í˜• */
            font-size: 18px; font-weight: bold;
            cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.1s, background 0.1s;
            
            /* í…ìŠ¤íŠ¸ ì •ë ¬ */
            display: flex; align-items: center; justify-content: center;
            text-align: center;
            line-height: 1.2;
        }
        .word-block:active { transform: scale(0.95); }
        .word-block.used { opacity: 0; pointer-events: none; width: 0; padding: 0; margin: 0; border: 0; overflow: hidden; }

        /* ìŠ¬ë¡¯ì— ë“¤ì–´ê°„ ë¸”ë¡ */
        .us-mid .word-block {
            background: #3498db; color: white; border-color: #3498db;
            box-shadow: none;
        }

        @keyframes pop { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        /* ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ */
        .nav-btn {
            position: absolute; top: 50%; transform: translateY(-50%);
            background: rgba(255,255,255,0.8); border: 1px solid #ddd;
            width: 60px; height: 60px; border-radius: 50%;
            font-size: 28px; cursor: pointer; color: #2c3e50;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 20;
            display: flex; justify-content: center; align-items: center;
        }
        .nav-prev { left: 10px; }
        .nav-next { right: 10px; }
        .progress-bar { position: absolute; bottom: 15px; font-size: 14px; color: #95a5a6; font-weight: bold; left: 50%; transform: translateX(-50%); }

        @media (max-width: 768px) {
            .q-text { font-size: 24px; }
            .us-top .q-text { font-size: 20px; }
            .word-block { font-size: 16px; padding: 6px 12px; }
            .card { height: 100%; border-radius: 0; box-shadow: none; }
            .stage { padding: 0; } 
            .logo span { display: none; }
            select { max-width: 150px; }
        }
    </style>
</head>
<body>

    <header>
        <div class="logo">ğŸ“ <span>Pattern Activity</span></div>
        <div class="menu-group">
            <select id="bookSel" onchange="updatePatterns(); resizeSelect(this)"></select>
            <select id="patSel" onchange="resetActivity(); resizeSelect(this)"></select>
            <select id="actSel" onchange="resetActivity(); resizeSelect(this)">
                <option value="looksay">Look & Say</option>
                <option value="unscramble">Unscramble</option>
            </select>
        </div>
    </header>

    <div class="stage" id="touchStage">
        <button class="nav-btn nav-prev" onclick="prevSlide()">â®</button>
        <button class="nav-btn nav-next" onclick="nextSlide()">â¯</button>

        <div class="card">
            
            <div id="lookSayContainer">
                <div class="ls-upper">
                    <div id="lsText" class="q-text">Loading...</div>
                    <img id="lsImg" class="q-image" src="" alt="Question">
                    <div id="lsEmoji" class="q-emoji"></div>
                </div>
                <div class="ls-lower">
                    <div class="answer-box" id="aBox" onclick="toggleAnswer()">
                        ğŸ‘† Tap to check answer
                    </div>
                </div>
            </div>

            <div id="unscrambleContainer">
                <div class="us-top">
                    <div id="usText" class="q-text">Question</div>
                </div>
                <div id="slotArea" class="us-mid"></div>
                <div id="poolArea" class="us-bot"></div>
            </div>

        </div>

        <div class="progress-bar" id="progress">1 / 10</div>
    </div>

    <script src="data.js"></script>

    <script>
        // --- ë©”ë‰´ ë„ˆë¹„ ìë™ ì¡°ì ˆ ---
        function resizeSelect(sel) {
            let tempSpan = document.createElement("span");
            tempSpan.style.visibility = "hidden";
            tempSpan.style.position = "absolute";
            tempSpan.style.fontSize = "14px";
            tempSpan.style.fontWeight = "bold";
            tempSpan.style.fontFamily = "'Pretendard', sans-serif";
            tempSpan.innerText = sel.options[sel.selectedIndex].text;
            document.body.appendChild(tempSpan);
            let width = tempSpan.offsetWidth + 45; 
            document.body.removeChild(tempSpan);
            sel.style.width = width + "px";
        }

        // --- ì „ì—­ ë³€ìˆ˜ ---
        let currentItems = [];
        let currentIndex = 0;
        let currentMode = "looksay"; 
        const PLACEHOLDER_TEXT = "ğŸ‘† Tap to check answer";
        
        // Unscramble ìƒíƒœ
        let unscrambleState = { targetSentence: "", scrambledWords: [], userSelection: [] };

        window.onload = function() {
            if (typeof bookData === 'undefined') {
                alert("data.js íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return;
            }
            initBookMenu();
            initTouchEvents();
            resizeSelect(document.getElementById('actSel'));
        };

        function initBookMenu() {
            const bookSel = document.getElementById('bookSel');
            Object.keys(bookData).forEach(book => {
                bookSel.innerHTML += `<option value="${book}">${book}</option>`;
            });
            updatePatterns();
            resizeSelect(bookSel);
        }

        function updatePatterns() {
            const bookName = document.getElementById('bookSel').value;
            const patSel = document.getElementById('patSel');
            const items = bookData[bookName];
            const pSet = new Set(items.map(d => d["Pattern #"]));
            
            patSel.innerHTML = "";
            pSet.forEach(p => {
                const name = items.find(d => d["Pattern #"] == p)["Pattern Name"];
                patSel.innerHTML += `<option value="${p}">${p}. ${name}</option>`;
            });
            resizeSelect(patSel);
            resetActivity();
        }

        function resetActivity() {
            const bookName = document.getElementById('bookSel').value;
            const pNum = parseInt(document.getElementById('patSel').value);
            currentMode = document.getElementById('actSel').value;
            
            const allItems = bookData[bookName].filter(d => d["Pattern #"] === pNum);
            
            if (currentMode === 'looksay') {
                currentItems = allItems.filter(d => d.Section === "Speaking II");
                if (currentItems.length === 0) currentItems = allItems.filter(d => d.Section === "Unscramble");
            } else {
                currentItems = allItems.filter(d => d.Section === "Unscramble");
                if (currentItems.length === 0) currentItems = allItems.filter(d => d.Section === "Speaking II");
            }

            currentIndex = 0;
            renderSlide();
        }

        function renderSlide() {
            if (currentItems.length === 0) return;
            const item = currentItems[currentIndex];
            const progress = document.getElementById('progress');
            progress.innerText = `${currentIndex + 1} / ${currentItems.length}`;

            // ì»¨í…Œì´ë„ˆ ì œì–´
            const lsContainer = document.getElementById('lookSayContainer');
            const usContainer = document.getElementById('unscrambleContainer');

            if (currentMode === 'looksay') {
                lsContainer.style.display = 'flex';
                usContainer.style.display = 'none';
                renderLookSay(item);
            } else {
                lsContainer.style.display = 'none';
                usContainer.style.display = 'flex';
                initUnscrambleGame(item);
            }
        }

        // --- Look & Say ë Œë”ë§ ---
        function renderLookSay(item) {
            const qText = document.getElementById('lsText');
            const qImg = document.getElementById('lsImg');
            const qEmoji = document.getElementById('lsEmoji');
            const aBox = document.getElementById('aBox');

            qText.style.display = "none";
            qImg.style.display = "none";
            qEmoji.style.display = "none";

            const imageVal = item["Image"] ? item["Image"].trim() : "";
            if (imageVal !== "") {
                if (imageVal.includes('.') || imageVal.includes('/')) {
                    qImg.src = "images/" + imageVal;
                    qImg.style.display = "block";
                } else {
                    qEmoji.innerText = imageVal;
                    qEmoji.style.display = "block";
                }
            } else {
                qText.innerText = item["Korean/Question"];
                qText.style.display = "block";
            }

            aBox.className = "answer-box";
            aBox.innerText = PLACEHOLDER_TEXT;
        }

        function toggleAnswer() {
            if (currentMode !== 'looksay') return;
            const item = currentItems[currentIndex];
            const aBox = document.getElementById('aBox');
            if (aBox.classList.contains('visible')) {
                aBox.classList.remove('visible');
                aBox.innerText = PLACEHOLDER_TEXT;
            } else {
                aBox.classList.add('visible');
                aBox.innerText = item["English/Answer"];
            }
        }

        // --- Unscramble ê²Œì„ ë¡œì§ ---
        function initUnscrambleGame(item) {
            const usText = document.getElementById('usText');
            const slotArea = document.getElementById('slotArea');
            const poolArea = document.getElementById('poolArea');

            // 1. ìƒë‹¨: í•œê¸€ ì§ˆë¬¸
            usText.innerText = item["Korean/Question"];

            // 2. ì´ˆê¸°í™”
            slotArea.innerHTML = "";
            poolArea.innerHTML = "";
            slotArea.className = "us-mid";
            unscrambleState.userSelection = [];
            unscrambleState.targetSentence = item["English/Answer"];

            // 3. ë‹¨ì–´ ì¤€ë¹„
            let rawStr = item["Scrambled"];
            if (!rawStr || rawStr === "") rawStr = item["English/Answer"];
            
            let words = rawStr.includes("/") ? rawStr.split("/") : rawStr.split(" ");
            words = words.map(w => w.trim());
            
            // ëœë¤ ì„ê¸°
            words.sort(() => Math.random() - 0.5);
            unscrambleState.scrambledWords = words;

            // 4. ë‹¨ì–´ ë¸”ë¡ ìƒì„±
            words.forEach((word, idx) => {
                let btn = document.createElement("div");
                btn.className = "word-block";
                btn.innerText = word;
                btn.onclick = () => selectWord(btn, word, idx);
                poolArea.appendChild(btn);
            });
        }

        function selectWord(btnElement, word, idx) {
            btnElement.classList.add("used");
            
            const slotArea = document.getElementById('slotArea');
            let slotBtn = document.createElement("div");
            slotBtn.className = "word-block";
            slotBtn.innerText = word;
            slotBtn.onclick = () => deselectWord(slotBtn, btnElement);
            
            slotArea.appendChild(slotBtn);
            unscrambleState.userSelection.push(word);

            checkResult();
        }

        function deselectWord(slotBtn, originalBtn) {
            slotBtn.remove();
            originalBtn.classList.remove("used");
            
            const currentSlots = document.querySelectorAll("#slotArea .word-block");
            unscrambleState.userSelection = Array.from(currentSlots).map(el => el.innerText);
            
            document.getElementById('slotArea').classList.remove("correct");
        }

        function checkResult() {
            const userSent = unscrambleState.userSelection.join(" ");
            const target = unscrambleState.targetSentence;
            
            const cleanUser = userSent.replace(/[^a-zA-Z0-9]/g, "").toLowerCase();
            const cleanTarget = target.replace(/[^a-zA-Z0-9]/g, "").toLowerCase();

            if (cleanUser === cleanTarget && cleanUser.length > 0) {
                document.getElementById('slotArea').classList.add("correct");
                if(navigator.vibrate) navigator.vibrate(50);
            }
        }

        // --- ë„¤ë¹„ê²Œì´ì…˜ ---
        function nextSlide() {
            if (currentIndex < currentItems.length - 1) {
                currentIndex++;
                renderSlide();
            }
        }

        function prevSlide() {
            if (currentIndex > 0) {
                currentIndex--;
                renderSlide();
            }
        }

        function initTouchEvents() {
            let touchStartX = 0;
            let touchEndX = 0;
            const stage = document.getElementById('touchStage');
            stage.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; }, {passive: true});
            stage.addEventListener('touchend', e => { 
                touchEndX = e.changedTouches[0].screenX; 
                if (touchEndX < touchStartX - 60) nextSlide();
                if (touchEndX > touchStartX + 60) prevSlide();
            }, {passive: true});
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === "ArrowRight") nextSlide();
            if (e.key === "ArrowLeft") prevSlide();
            if (e.key === " " || e.key === "Enter") toggleAnswer();
        });
    </script>
</body>
</html>