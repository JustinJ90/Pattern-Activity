<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pattern Master Class (v10)</title>
    <style>
        /* --- Í∏∞Î≥∏ ÏÑ§Ï†ï --- */
        body {
            font-family: 'Pretendard', 'Malgun Gothic', sans-serif;
            background-color: #2c3e50;
            margin: 0; padding: 0;
            height: 100vh; display: flex; flex-direction: column;
            overflow: hidden; user-select: none; -webkit-user-select: none;
        }

        /* --- Ìó§Îçî --- */
        header {
            background-color: #34495e; padding: 10px 20px;
            display: flex; align-items: center; justify-content: space-between;
            height: 60px; flex-shrink: 0; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 100;
        }
        .logo { font-size: 18px; font-weight: bold; color: #ecf0f1; display: flex; align-items: center; gap: 8px; }
        .menu-group { display: flex; gap: 10px; align-items: center; }

        select#actSel {
            background-color: #2c3e50; color: white; border: 1px solid #5d6d7e;
            padding: 8px 10px; border-radius: 8px; font-size: 14px;
            outline: none; font-weight: bold; cursor: pointer;
            width: auto; min-width: 150px;
        }

        .setting-btn {
            background: #ecf0f1; color: #2c3e50; border: none;
            width: 40px; height: 40px; border-radius: 50%;
            font-size: 20px; cursor: pointer; display: flex; justify-content: center; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: 0.2s;
        }
        .setting-btn:active { transform: scale(0.9); }

        /* --- Î©îÏù∏ Ïä§ÌÖåÏù¥ÏßÄ --- */
        .stage {
            flex: 1; display: flex; justify-content: center; align-items: center;
            position: relative; padding: 20px; width: 100%; box-sizing: border-box;
            background-color: #ecf0f1;
        }
        .card {
            background: white; width: 100%; max-width: 900px; height: 100%; max-height: 600px;
            border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex; flex-direction: column; overflow: hidden; position: relative;
        }

        /* === ‚öôÔ∏è ÏÑ§Ï†ï Î™®Îã¨ === */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8); z-index: 2000;
            display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
        }
        .modal-box {
            background: white; width: 90%; max-width: 550px; max-height: 90vh;
            border-radius: 20px; padding: 25px; display: flex; flex-direction: column;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .modal-header { font-size: 22px; font-weight: bold; color: #2c3e50; margin-bottom: 15px; text-align: center; }
        
        .modal-section-title { font-size: 14px; font-weight: bold; color: #7f8c8d; margin-bottom: 8px; margin-top: 10px;}

        .modal-book-sel {
            width: 100%; padding: 10px; font-size: 16px; border-radius: 8px;
            border: 2px solid #bdc3c7; margin-bottom: 5px; font-weight: bold;
        }

        .checkbox-container {
            flex: 1; overflow-y: auto; border: 1px solid #eee; border-radius: 10px;
            padding: 10px; margin-bottom: 10px; background: #f9f9f9;
            display: grid; grid-template-columns: 1fr 1fr; gap: 8px; min-height: 150px;
        }
        .chk-item {
            display: flex; align-items: center; gap: 8px; padding: 8px;
            background: white; border-radius: 8px; border: 1px solid #ddd; cursor: pointer;
        }
        .chk-item:hover { background: #f0f8ff; border-color: #3498db; }
        .chk-item input { transform: scale(1.3); cursor: pointer; }
        .chk-label { font-size: 13px; font-weight: bold; color: #555; user-select: none; }

        /* Î¨∏Ìï≠ Ïàò ÏÑ†ÌÉù UI */
        .count-options { display: flex; gap: 5px; justify-content: space-between; margin-bottom: 20px; }
        .cnt-btn {
            flex: 1; padding: 10px 0; border: 1px solid #bdc3c7; background: white;
            border-radius: 8px; cursor: pointer; font-weight: bold; color: #34495e;
            transition: 0.2s; font-size: 14px;
        }
        .cnt-btn.selected { background: #2c3e50; color: white; border-color: #2c3e50; }
        .cnt-btn:disabled { background: #f0f0f0; color: #ccc; border-color: #eee; cursor: not-allowed; }

        .modal-actions { display: flex; gap: 10px; }
        .modal-btn {
            flex: 1; padding: 15px; border: none; border-radius: 10px;
            font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.2s;
        }
        .btn-start { background: #3498db; color: white; }
        .btn-start:hover { background: #2980b9; }
        .btn-all { background: #95a5a6; color: white; flex: 0.3; font-size: 14px; }

        /* === üèÜ Ï†êÏàòÌåê UI === */
        .score-badge {
            position: absolute; top: 70px; padding: 8px 15px; min-width: 50px;
            border-radius: 12px; font-weight: 900; font-size: 28px; color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15); z-index: 60;
            display: none; flex-direction: column; align-items: center; line-height: 1;
            transition: transform 0.2s;
        }
        .score-badge.pop { transform: scale(1.3); }
        .score-blue { left: 20px; background: #3498db; border: 2px solid #2980b9; }
        .score-red { right: 20px; background: #e74c3c; border: 2px solid #c0392b; }
        .score-title { font-size: 10px; margin-bottom: 3px; opacity: 0.9; font-weight: normal; text-transform: uppercase; }

        /* === ÌÉÄÏù¥Î®∏ & Ìè≠ÌÉÑ UI === */
        .timer-container { position: absolute; top: 0; left: 0; width: 100%; height: 10px; background: #ddd; z-index: 50; display: none; }
        .bomb-icon { position: absolute; left: 5px; top: 12px; font-size: 40px; z-index: 51; transform: translateY(-50%); transition: transform 0.2s; filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.2)); }
        .timer-bar { height: 100%; background: #e74c3c; width: 100%; transition: width 1s linear; border-radius: 0 5px 5px 0; }
        .timer-container.urgent .bomb-icon { animation: shake 0.5s infinite; }
        .timer-container.urgent .timer-bar { background: #c0392b; }

        .explosion-popup { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); font-size: 150px; z-index: 200; pointer-events: none; transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); text-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        .explosion-popup.boom { transform: translate(-50%, -50%) scale(1); animation: shake 0.5s; }

        /* === Layout Styles === */
        #lookSayLayout { display: flex; flex-direction: column; height: 100%; width: 100%; }
        .ls-upper { flex: 2; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; text-align: center; border-bottom: 1px solid #eee; overflow: hidden;}
        .ls-lower { flex: 1; display: flex; justify-content: center; align-items: center; padding: 20px; background-color: #fafafa; }
        
        .q-text { font-size: 36px; font-weight: 800; color: #2c3e50; line-height: 1.4; word-break: keep-all; }
        .q-image { max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 10px; display: none; }
        .q-emoji { font-size: 140px; line-height: 1; display: none; animation: pop 0.3s; }
        .blank-text { font-size: 32px; font-weight: bold; color: #2c3e50; line-height: 1.6; display: none; }

        .answer-box { width: 90%; height: 70%; border-radius: 15px; font-weight: bold; font-size: 24px; cursor: pointer; display: flex; justify-content: center; align-items: center; text-align: center; background-color: white; color: #95a5a6; border: 2px dashed #bdc3c7; transition: all 0.2s; }
        .answer-box.visible { background-color: #3498db; color: white; border: 2px solid #3498db; box-shadow: 0 8px 20px rgba(52, 152, 219, 0.4); transform: translateY(-5px); }

        .speed-check-area { display: none; width: 100%; gap: 20px; justify-content: center; }
        .speed-btn { flex: 1; max-width: 150px; height: 70px; border-radius: 15px; border: none; font-size: 30px; font-weight: bold; color: white; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.2); transition: transform 0.1s; }
        .speed-btn:active { transform: scale(0.95); }
        .btn-o { background: #2ecc71; } .btn-x { background: #e74c3c; }

        #unscrambleLayout { display: none; flex-direction: column; height: 100%; width: 100%; }
        .us-top { flex: 1; display: flex; justify-content: center; align-items: center; padding: 10px 20px; border-bottom: 1px solid #eee; background: #fff; }
        .us-mid { flex: 1.2; background: #f0f4f8; padding: 20px; display: flex; flex-wrap: wrap; align-content: center; justify-content: center; gap: 8px; overflow-y: auto; transition: background 0.3s; }
        .us-mid.correct { background: #e3f9e5; box-shadow: inset 0 0 20px rgba(46, 204, 113, 0.2); }
        .us-bot { flex: 1; padding: 20px; background: white; border-top: 1px solid #eee; display: flex; flex-wrap: wrap; justify-content: center; align-content: center; gap: 10px; }

        .word-block { background: white; border: 2px solid #3498db; color: #2c3e50; padding: 8px 16px; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: transform 0.1s; display: flex; align-items: center; justify-content: center; text-align: center; }
        .word-block:active { transform: scale(0.95); }
        .word-block.used { display: none !important; }
        .listen-btn { background: #f1c40f; color: #2c3e50; border: none; padding: 10px 30px; border-radius: 50px; font-size: 22px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: transform 0.2s; display: none; align-items: center; gap: 10px; }

        #memoryLayout { display: none; height: 100%; width: 100%; padding: 40px 20px 20px; box-sizing: border-box; flex-wrap: wrap; align-content: center; justify-content: center; gap: 10px; background: #f8f9fa; position: relative; }
        .mem-stats { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); font-size: 18px; font-weight: bold; color: #34495e; background: rgba(255,255,255,0.9); padding: 5px 15px; border-radius: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 10; display: flex; gap: 10px; }
        .mem-card { width: calc(25% - 10px); height: calc(33% - 10px); position: relative; perspective: 1000px; cursor: pointer; }
        .mem-inner { width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .mem-card.flipped .mem-inner { transform: rotateY(180deg); }
        .mem-card.matched { visibility: hidden; opacity: 0; transition: opacity 0.5s; pointer-events: none; }
        .mem-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; justify-content: center; align-items: center; border-radius: 10px; padding: 10px; box-sizing: border-box; font-weight: bold; word-break: keep-all; font-size: 14px; }
        .mem-front { background-color: #34495e; color: #ecf0f1; font-size: 24px; }
        .mem-back { background-color: white; color: #2c3e50; border: 2px solid #3498db; transform: rotateY(180deg); }

        #quizLayout { display: none; flex-direction: column; height: 100%; width: 100%; padding-top: 15px;}
        .quiz-q-area { flex: 1; display: flex; justify-content: center; align-items: center; padding: 20px; text-align: center; }
        .quiz-body { flex: 1.5; padding: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; background: #ecf0f1; }
        .quiz-btn { background: white; border: 3px solid #bdc3c7; border-radius: 15px; font-size: 18px; font-weight: bold; color: #34495e; cursor: pointer; transition: 0.2s; display: flex; justify-content: center; align-items: center; text-align: center; padding: 10px; word-break: keep-all; line-height: 1.3; box-shadow: 0 3px 6px rgba(0,0,0,0.05); }
        .quiz-btn.correct { background: #2ecc71; border-color: #27ae60; color: white; }
        .quiz-btn.wrong { background: #e74c3c; border-color: #c0392b; color: white; animation: shake 0.4s; }

        #flashLayout { display: none; flex-direction: column; height: 100%; width: 100%; padding-top: 20px; background: #ecf0f1; }
        .flash-list { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 12px; padding: 20px 40px; overflow-y: auto; }
        .flash-btn { width: 100%; max-width: 600px; padding: 15px; background: white; border: 2px solid #bdc3c7; border-radius: 12px; font-size: 20px; font-weight: bold; color: #34495e; cursor: pointer; text-align: center; transition: 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .flash-btn:active { transform: scale(0.98); }
        .flash-btn.correct { background: #2ecc71; border-color: #27ae60; color: white; }
        .flash-btn.wrong { background: #e74c3c; border-color: #c0392b; color: white; animation: shake 0.4s; }

        .flash-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #2c3e50; color: white; z-index: 50; display: none; flex-direction: column; justify-content: center; align-items: center; font-size: 40px; font-weight: 900; text-align: center; padding: 20px; box-sizing: border-box;}
        
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 50% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); } }
        @keyframes pop { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        .nav-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.8); border: 1px solid #ddd; width: 60px; height: 60px; border-radius: 50%; font-size: 28px; cursor: pointer; color: #2c3e50; box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 20; display: flex; justify-content: center; align-items: center; }
        .nav-prev { left: 10px; } .nav-next { right: 10px; }
        .progress-bar { position: absolute; bottom: 15px; font-size: 14px; color: #95a5a6; font-weight: bold; left: 50%; transform: translateX(-50%); z-index: 5;}
        
        .hidden { display: none !important; }

        @media (max-width: 768px) {
            .mem-card { width: calc(33% - 10px); height: calc(25% - 10px); }
            .quiz-body { grid-template-columns: 1fr; }
            .q-text { font-size: 24px; }
            .word-block { font-size: 16px; padding: 6px 12px; }
            .flash-btn { font-size: 16px; padding: 12px; }
            .card { height: 100%; border-radius: 0; }
            .stage { padding: 0; } .logo span { display: none; }
            select { max-width: 150px; }
        }
    </style>
</head>
<body>

<header>
    <div class="logo">üéì <span>Pattern Master</span></div>
    <div class="menu-group">
        <select id="actSel" onchange="resetActivity()">
            <option value="looksay">1. Look & Say</option>
            <option value="unscramble">2. Unscramble</option>
            <option value="dictation">3. Block Dictation</option>
            <option value="blanks">4. Pattern Blanks</option>
            <option value="speed">5. Speed Game</option>
            <option value="memory">6. Memory Match üÉè</option>
            <option value="quiz">7. Quiz Show üí£</option>
            <option value="flash">8. Flash Sentence ‚ö°</option>
        </select>
        <button class="setting-btn" onclick="openModal()">‚öôÔ∏è</button>
    </div>
</header>

<div id="setupModal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header">üìö ÌïôÏäµ Î≤îÏúÑ ÏÑ§Ï†ï</div>
        
        <div class="modal-section-title">1. ÍµêÏû¨ Î∞è Ïú†Îãõ ÏÑ†ÌÉù</div>
        <select id="modalBookSel" class="modal-book-sel" onchange="renderCheckboxes()"></select>
        
        <div id="checkboxList" class="checkbox-container"></div>

        <div class="modal-section-title">2. Î¨∏Ìï≠ Ïàò Ï†úÌïú</div>
        <div class="count-options">
            <button class="cnt-btn" onclick="selectCount(10)">10</button>
            <button class="cnt-btn" onclick="selectCount(20)">20</button>
            <button class="cnt-btn" onclick="selectCount(30)">30</button>
            <button class="cnt-btn" onclick="selectCount(40)">40</button>
            <button class="cnt-btn" onclick="selectCount(50)">50</button>
            <button class="cnt-btn selected" onclick="selectCount(999)">All</button>
        </div>

        <div class="modal-actions">
            <button class="modal-btn btn-all" onclick="toggleAllChecks()">All Check</button>
            <button class="modal-btn btn-start" onclick="startWithSelection()">üöÄ ÏàòÏóÖ ÏãúÏûë</button>
        </div>
    </div>
</div>

<div class="stage" id="touchStage">
    <button class="nav-btn nav-prev" onclick="prevSlide()">‚ùÆ</button>
    <button class="nav-btn nav-next" onclick="nextSlide()">‚ùØ</button>

    <div class="card">
        <div id="scoreBoardBlue" class="score-badge score-blue">
            <span class="score-title">CORRECT</span><span id="scoreValBlue">0</span>
        </div>
        <div id="scoreBoardRed" class="score-badge score-red">
            <span class="score-title">WRONG</span><span id="scoreValRed">0</span>
        </div>

        <div id="gameTimer" class="timer-container">
            <div class="bomb-icon">üí£</div><div id="timerBar" class="timer-bar"></div>
        </div>
        <div id="explosionPopup" class="explosion-popup">üí•</div>
        <div id="flashOverlay" class="flash-overlay"><div id="flashContent">Ready...</div></div>

        <div id="lookSayLayout">
            <div class="ls-upper">
                <div id="qText" class="q-text">Loading...</div>
                <div id="blankText" class="blank-text"></div>
                <img id="qImg" class="q-image" src="" alt="Question">
                <div id="qEmoji" class="q-emoji"></div>
            </div>
            <div class="ls-lower">
                <div class="answer-box" id="aBox" onclick="toggleAnswer()">üëÜ Tap to check answer</div>
                <div id="speedCheckArea" class="speed-check-area">
                    <button class="speed-btn btn-o" onclick="rateSpeedGame(true)">O</button>
                    <button class="speed-btn btn-x" onclick="rateSpeedGame(false)">X</button>
                </div>
            </div>
        </div>

        <div id="unscrambleLayout">
            <div class="us-top">
                <div id="usText" class="q-text">Question</div>
                <button id="listenBtn" class="listen-btn" onclick="speakText()">üîä Listen & Build</button>
            </div>
            <div id="usSlot" class="us-mid"></div>
            <div id="usPool" class="us-bot"></div>
        </div>

        <div id="memoryLayout">
            <div class="mem-stats"><span>‚ù§Ô∏è Moves: <span id="memMoves">20</span></span></div>
        </div>

        <div id="quizLayout">
            <div class="quiz-q-area"><div id="quizQ" class="q-text">Question</div></div>
            <div id="quizBody" class="quiz-body"></div>
        </div>

        <div id="flashLayout">
            <div id="flashOptions" class="flash-list"></div>
        </div>
    </div>

    <div class="progress-bar" id="progress">Setting Up...</div>
</div>

<script src="data.js"></script>
<script>
    let currentItems = [];
    let currentIndex = 0;
    let currentMode = "looksay";
    let timerId = null; 
    let autoNextId = null; 
    let unscrambleState = { target: "", selected: [] };
    
    let scoreCorrect = 0;
    let scoreWrong = 0;
    let memoryFlipped = [];
    let memoryMoves = 20;
    let quizAnswerIdx = 0;
    let quizLocked = false;
    let flashDuration = 700;

    let currentBookName = "";
    let selectedMaxCount = 999; 

    window.onload = function() {
        if (typeof bookData === 'undefined') { alert("data.js ÏóÜÏùå"); return; }
        
        const modalBookSel = document.getElementById('modalBookSel');
        Object.keys(bookData).forEach((book, idx) => {
            let op = document.createElement('option');
            op.value = book; op.text = book;
            modalBookSel.appendChild(op);
            if(idx===0) currentBookName = book;
        });

        renderCheckboxes();
        openModal(); 
        initTouchEvents();
    };

    function openModal() { document.getElementById('setupModal').style.display = 'flex'; }
    function closeModal() { document.getElementById('setupModal').style.display = 'none'; }

    function renderCheckboxes() {
        currentBookName = document.getElementById('modalBookSel').value;
        const list = document.getElementById('checkboxList');
        list.innerHTML = "";

        const items = bookData[currentBookName];
        const patternMap = new Map();
        items.forEach(d => { patternMap.set(d["Pattern #"], d["Pattern Name"]); });

        const sortedPatterns = Array.from(patternMap.keys()).sort((a,b)=>a-b);
        
        sortedPatterns.forEach(pNum => {
            let pName = patternMap.get(pNum);
            let div = document.createElement('div');
            div.className = 'chk-item';
            div.innerHTML = `<input type="checkbox" value="${pNum}"> <span class="chk-label">${pNum}. ${pName}</span>`;
            div.onclick = (e) => {
                if(e.target.tagName !== 'INPUT') {
                    let chk = div.querySelector('input');
                    chk.checked = !chk.checked;
                }
                updateCountOptionsState(); // Ï≤¥ÌÅ¨Ìï† ÎïåÎßàÎã§ ÏòµÏÖò ÏÉÅÌÉú Í∞±Ïã†
            };
            // Input ÌÅ¥Î¶≠ÏãúÏóêÎèÑ Ïù¥Î≤§Ìä∏ Ï†ÑÌååÎêòÎØÄÎ°ú Ï§ëÎ≥µ Î∞©ÏßÄ ÌïÑÏöîÌïòÏßÄÎßå Í∞ÑÎã®Ìûà Îë†
            div.querySelector('input').onclick = () => updateCountOptionsState();
            list.appendChild(div);
        });
        updateCountOptionsState();
    }

    function toggleAllChecks() {
        const chks = document.querySelectorAll('#checkboxList input');
        let allChecked = Array.from(chks).every(c => c.checked);
        chks.forEach(c => c.checked = !allChecked);
        updateCountOptionsState();
    }

    // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Î¨∏Ìï≠ Ïàò Í≥ÑÏÇ∞ Î∞è Î≤ÑÌäº ÌôúÏÑ±/ÎπÑÌôúÏÑ±Ìôî
    function updateCountOptionsState() {
        const chks = document.querySelectorAll('#checkboxList input:checked');
        const selectedPNums = Array.from(chks).map(c => parseInt(c.value));
        const allCandidates = bookData[currentBookName].filter(d => selectedPNums.includes(d["Pattern #"]));
        // ÌõÑÎ≥¥Íµ∞Ïù¥ Speaking II ÏôÄ Unscramble Ï§ë ÌïòÎÇòÎßå ÏûàÏñ¥ÎèÑ Ïπ¥Ïö¥Ìä∏ Îê† Ïàò ÏûàÏúºÎØÄÎ°ú, 
        // Ïã§Ï†ú Í≤åÏûÑ Í∞ÄÎä• Î¨∏Ìï≠ÏàòÎäî ÎåÄÎûµ Speaking II Í∞úÏàò Í∏∞Ï§Ä (Î≥¥ÌÜµ Ìå®ÌÑ¥Îãπ 10Í∞ú)
        // Ïó¨Í∏∞ÏÑúÎäî Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ ÏàòÎ•º 2Î°ú ÎÇòÎàÑÍ±∞ÎÇò(ÏÑπÏÖòÏ§ëÎ≥µ), Ìå®ÌÑ¥Îãπ 10Í∞úÎ°ú Í∞ÄÏ†ï.
        // Ï†ïÌôïÌïòÍ≤åÎäî: filter(Section == Speaking II).length
        
        let validCount = allCandidates.filter(d => d.Section === "Speaking II").length;
        if(validCount === 0) validCount = allCandidates.length; // Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞ÏÉÅ ÏòàÏô∏Ï≤òÎ¶¨

        const btns = document.querySelectorAll('.cnt-btn');
        btns.forEach(btn => {
            let val = parseInt(btn.innerText);
            if(isNaN(val)) val = 999; // All
            
            if(val > validCount && val !== 999) {
                btn.disabled = true;
                if(btn.classList.contains('selected')) selectCount(999); // ÏÑ†ÌÉùÎêúÍ≤å Î∂àÍ∞ÄÎä•Ìï¥ÏßÄÎ©¥ AllÎ°ú
            } else {
                btn.disabled = false;
            }
        });
    }

    function selectCount(cnt) {
        selectedMaxCount = cnt;
        const btns = document.querySelectorAll('.cnt-btn');
        btns.forEach(b => {
            let val = parseInt(b.innerText);
            if(isNaN(val)) val = 999;
            if(val === cnt) b.classList.add('selected');
            else b.classList.remove('selected');
        });
    }

    function startWithSelection() {
        const chks = document.querySelectorAll('#checkboxList input:checked');
        if(chks.length === 0) { alert("Ï†ÅÏñ¥ÎèÑ ÌïòÎÇòÏùò Ïú†ÎãõÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî."); return; }

        const selectedPNums = Array.from(chks).map(c => parseInt(c.value));
        let allCandidates = bookData[currentBookName].filter(d => selectedPNums.includes(d["Pattern #"]));
        
        // ÌïÑÌÑ∞ÎßÅÎêú Îç∞Ïù¥ÌÑ∞Î•º ÏÑ∏ÏÖò Î≥ÄÏàòÏóê Ï†ÄÏû• (ÎÇòÏ§ëÏóê Î™®Îìú Î∞îÎÄî Îïå ÌïÑÌÑ∞ÎßÅ ÏõêÎ≥∏ÏúºÎ°ú Ïì∞ÏûÑ)
        window.filteredDataForSession = allCandidates;
        
        closeModal();
        resetActivity();
    }

    // --- Main Logic ---

    function resetActivity() {
        currentMode = document.getElementById('actSel').value;
        
        if (!window.filteredDataForSession) return; 

        let candidates = window.filteredDataForSession;
        let pool = [];

        if (['unscramble', 'dictation', 'flash', 'quiz'].includes(currentMode)) {
            pool = candidates.filter(d => d.Section === "Unscramble");
            if (pool.length === 0) pool = candidates.filter(d => d.Section === "Speaking II");
        } else {
            pool = candidates.filter(d => d.Section === "Speaking II");
            if (pool.length === 0) pool = candidates.filter(d => d.Section === "Unscramble");
        }

        // Shuffle
        pool.sort(() => Math.random() - 0.5);

        // Apply Count Limit
        if (selectedMaxCount !== 999 && pool.length > selectedMaxCount) {
            currentItems = pool.slice(0, selectedMaxCount);
        } else {
            currentItems = pool;
        }

        flashDuration = 700; 
        clearTimeout(timerId);
        clearTimeout(autoNextId);
        scoreCorrect = 0; scoreWrong = 0;
        updateScoreBoard();

        if (currentMode === 'memory') {
            currentIndex = 0; renderMemoryGame();
        } else {
            currentIndex = 0; renderSlide();
        }
    }

    function updateScoreBoard() {
        const sBlue = document.getElementById('scoreValBlue');
        const sRed = document.getElementById('scoreValRed');
        const badgeBlue = document.getElementById('scoreBoardBlue');
        const badgeRed = document.getElementById('scoreBoardRed');

        sBlue.innerText = scoreCorrect;
        sRed.innerText = scoreWrong;

        const isGameMode = ['speed', 'quiz', 'flash'].includes(currentMode);
        badgeBlue.style.display = isGameMode ? 'flex' : 'none';
        badgeRed.style.display = isGameMode ? 'flex' : 'none';
    }

    function addScore(isCorrect) {
        if(isCorrect) {
            scoreCorrect++;
            document.getElementById('scoreBoardBlue').classList.remove('pop');
            void document.getElementById('scoreBoardBlue').offsetWidth; 
            document.getElementById('scoreBoardBlue').classList.add('pop');
        } else {
            scoreWrong++;
            document.getElementById('scoreBoardRed').classList.remove('pop');
            void document.getElementById('scoreBoardRed').offsetWidth; 
            document.getElementById('scoreBoardRed').classList.add('pop');
        }
        updateScoreBoard();
    }

    function renderSlide() {
        clearTimeout(timerId); clearTimeout(autoNextId);

        if (currentMode === 'memory') return;
        if (!currentItems || currentItems.length === 0) return;
        const item = currentItems[currentIndex];
        
        const els = {
            ls: document.getElementById('lookSayLayout'),
            us: document.getElementById('unscrambleLayout'),
            mem: document.getElementById('memoryLayout'),
            quiz: document.getElementById('quizLayout'),
            flashDiv: document.getElementById('flashLayout'),
            overlay: document.getElementById('flashOverlay'),
            timer: document.getElementById('gameTimer'),
            boom: document.getElementById('explosionPopup'),
            prog: document.getElementById('progress'),
            speedCheck: document.getElementById('speedCheckArea'),
            aBox: document.getElementById('aBox')
        };

        [els.ls, els.us, els.mem, els.quiz, els.flashDiv, els.overlay, els.timer].forEach(e => e.style.display = 'none');
        els.boom.classList.remove('boom');
        els.timer.classList.remove('urgent');
        els.speedCheck.style.display = 'none'; 
        els.aBox.style.display = 'flex'; 
        els.aBox.style.cursor = 'pointer'; 
        els.aBox.onclick = toggleAnswer; 
        els.prog.innerText = `${currentIndex + 1} / ${currentItems.length}`;

        document.getElementById('qText').style.display = 'none';
        document.getElementById('qImg').style.display = 'none';
        document.getElementById('qEmoji').style.display = 'none';
        document.getElementById('blankText').style.display = 'none';

        let hasImage = false;
        let imageVal = item["Image"] ? item["Image"].trim() : "";
        if (imageVal && currentMode !== 'dictation') {
            hasImage = true;
            const qImg = document.getElementById('qImg');
            const qEmoji = document.getElementById('qEmoji');
            if (imageVal.includes('.') || imageVal.includes('/')) {
                qImg.src = "images/" + imageVal;
            } else {
                qEmoji.innerText = imageVal;
            }
        }

        updateScoreBoard(); 

        if (['looksay', 'blanks', 'speed'].includes(currentMode)) {
            els.ls.style.display = 'flex';
            els.aBox.className = "answer-box";
            els.aBox.innerText = "üëÜ Tap to check answer";

            if (currentMode === 'blanks') {
                let patName = item["Pattern Name"].replace(/[\.\~\?\[\]]/g, "").trim();
                let sentence = item["English/Answer"];
                let regex = new RegExp(patName, "i");
                let masked = sentence.replace(regex, "_______");
                if (masked === sentence) {
                    let parts = sentence.split(" ");
                    if(parts.length > 1) { parts[0] = "____"; parts[1] = "____"; masked = parts.join(" "); }
                }
                document.getElementById('blankText').innerHTML = masked; 
                document.getElementById('blankText').style.display = 'block';
            } else {
                if (hasImage) {
                    if(document.getElementById('qImg').src.includes(imageVal)) document.getElementById('qImg').style.display = 'block'; 
                    else document.getElementById('qEmoji').style.display = 'block';
                } else {
                    document.getElementById('qText').innerText = item["Korean/Question"]; 
                    document.getElementById('qText').style.display = 'block';
                }
            }

            if (currentMode === 'speed') {
                els.timer.style.display = 'block';
                startTimer(5000, () => {
                    if (!document.getElementById('aBox').classList.contains('visible')) toggleAnswer();
                });
            }
        } 
        else if (['unscramble', 'dictation'].includes(currentMode)) {
            els.us.style.display = 'flex';
            const usText = document.getElementById('usText');
            const listenBtn = document.getElementById('listenBtn');
            usText.style.display = 'block'; listenBtn.style.display = 'none';

            if (currentMode === 'dictation') {
                usText.style.display = 'none'; listenBtn.style.display = 'flex';
            } else {
                usText.innerText = item["Korean/Question"];
            }
            initUnscramble(item);
        }
        else if (currentMode === 'quiz') {
            els.quiz.style.display = 'flex';
            let isEngQuestion = Math.random() > 0.5;
            renderQuizOrFlash(item, false, isEngQuestion); 
        }
        else if (currentMode === 'flash') {
            els.overlay.style.display = 'flex'; 
            els.flashDiv.style.display = 'none'; 
            
            const fContent = document.getElementById('flashContent');
            fContent.innerText = "Ready...";
            
            let isEngQuestion = Math.random() > 0.5;
            let questionText = isEngQuestion ? item["English/Answer"] : item["Korean/Question"];

            setTimeout(() => {
                fContent.innerText = questionText; 
                if(navigator.vibrate) navigator.vibrate(50);
                
                setTimeout(() => {
                    els.overlay.style.display = 'none'; 
                    els.flashDiv.style.display = 'flex'; 
                    els.timer.style.display = 'block'; 
                    
                    renderQuizOrFlash(item, true, isEngQuestion); 
                    
                    startTimer(5000, () => { 
                        document.getElementById('explosionPopup').classList.add('boom');
                        if(navigator.vibrate) navigator.vibrate([200, 100, 200]);
                        quizLocked = true;
                        addScore(false); 
                        autoNextId = setTimeout(() => nextSlide(), 1500);
                    });

                }, flashDuration); 

            }, 1000); 
        }
    }

    function renderQuizOrFlash(item, isFlash, isEngQuestion) {
        quizLocked = false;
        let container, btnClass;
        let questionText = isEngQuestion ? item["English/Answer"] : item["Korean/Question"];

        if (!isFlash) {
            container = document.getElementById('quizBody');
            btnClass = 'quiz-btn';
            document.getElementById('quizQ').innerText = questionText;
        } else {
            container = document.getElementById('flashOptions');
            btnClass = 'flash-btn';
            document.getElementById('quizQ').innerText = "What was the sentence?";
        }
        
        container.innerHTML = "";
        
        let bookItems = bookData[document.getElementById('modalBookSel').value]; 
        
        let samePat = bookItems.filter(d => 
            d["Pattern #"] === item["Pattern #"] && 
            d["English/Answer"] !== item["English/Answer"] &&
            d["English/Answer"].trim() !== ""
        );
        let diffPat = bookItems.filter(d => 
            d["Pattern #"] !== item["Pattern #"] &&
            d["English/Answer"] && d["English/Answer"].trim() !== ""
        );

        samePat.sort(() => Math.random() - 0.5);
        diffPat.sort(() => Math.random() - 0.5);

        let distractors = [];
        if (samePat.length > 0) distractors.push(samePat[0]);
        if (samePat.length > 1) distractors.push(samePat[1]);
        
        let totalNeeded = isFlash ? 4 : 3;
        let remaining = totalNeeded - distractors.length;
        distractors = distractors.concat(diffPat.slice(0, remaining));

        let targetProp = isEngQuestion ? "Korean/Question" : "English/Answer";

        let choices = distractors.map(d => ({ txt: d[targetProp], isAns: false }));
        choices.push({ txt: item[targetProp], isAns: true });
        
        choices.sort(() => Math.random() - 0.5);
        quizAnswerIdx = choices.findIndex(c => c.isAns); 

        choices.forEach((c, idx) => {
            let btn = document.createElement('div');
            btn.className = btnClass;
            btn.innerText = c.txt;
            btn.onclick = () => checkQuizAndNext(btn, idx, isFlash);
            container.appendChild(btn);
        });

        if(!isFlash) {
            document.getElementById('gameTimer').style.display = 'block';
            startTimer(5000, () => {
                 document.getElementById('explosionPopup').classList.add('boom');
                 if(navigator.vibrate) navigator.vibrate([200, 100, 200]);
                 quizLocked = true;
                 addScore(false);
                 autoNextId = setTimeout(() => nextSlide(), 1500);
            });
        }
    }

    function checkQuizAndNext(btn, idx, isFlash) {
        if (quizLocked) return;
        quizLocked = true;
        clearTimeout(timerId);

        const btnClass = isFlash ? '.flash-btn' : '.quiz-btn';

        if (idx === quizAnswerIdx) {
            btn.classList.add('correct');
            addScore(true);
            if(navigator.vibrate) navigator.vibrate(50);
            if (isFlash && flashDuration > 200) flashDuration -= 50;
            autoNextId = setTimeout(() => nextSlide(), 500);
        } else {
            btn.classList.add('wrong');
            document.querySelectorAll(btnClass)[quizAnswerIdx].classList.add('correct');
            addScore(false);
            if(navigator.vibrate) navigator.vibrate(200);
            if(isFlash) flashDuration = 700;
            autoNextId = setTimeout(() => nextSlide(), 1500);
        }
    }

    function toggleAnswer() {
        const item = currentItems[currentIndex];
        const aBox = document.getElementById('aBox');
        if (aBox.classList.contains('visible')) {
            if(currentMode !== 'speed') {
                aBox.classList.remove('visible'); 
                aBox.innerText = "üëÜ Tap to check answer";
            }
        } else {
            aBox.classList.add('visible'); 
            aBox.innerText = item["English/Answer"];
            if(currentMode === 'speed') {
                clearTimeout(timerId);
                document.getElementById('speedCheckArea').style.display = 'flex';
                aBox.style.cursor = 'default';
                aBox.onclick = null; 
            }
        }
    }

    function rateSpeedGame(isCorrect) {
        addScore(isCorrect);
        nextSlide();
    }

    function initUnscramble(item) {
        const usSlot = document.getElementById('usSlot');
        const usPool = document.getElementById('usPool');
        usSlot.innerHTML = ""; usPool.innerHTML = ""; usSlot.className = "us-mid";
        unscrambleState.target = item["English/Answer"].replace(/[^a-zA-Z0-9]/g, "").toLowerCase();
        let raw = item["Scrambled"] || item["English/Answer"];
        let words = raw.includes("/") ? raw.split("/") : raw.split(" ");
        words = words.map(w=>w.trim()).sort(()=>Math.random()-0.5);
        words.forEach((w) => {
            let btn = document.createElement("div");
            btn.className = "word-block"; btn.innerText = w;
            btn.onclick = () => {
                btn.classList.add("used");
                let slotBtn = document.createElement("div");
                slotBtn.className = "word-block"; slotBtn.innerText = w;
                slotBtn.onclick = () => { slotBtn.remove(); btn.classList.remove("used"); checkUnscramble(); };
                usSlot.appendChild(slotBtn);
                checkUnscramble();
            };
            usPool.appendChild(btn);
        });
    }
    function checkUnscramble() {
        const currentWords = Array.from(document.querySelectorAll("#usSlot .word-block")).map(el=>el.innerText).join("");
        const currentClean = currentWords.replace(/[^a-zA-Z0-9]/g, "").toLowerCase();
        if (currentClean === unscrambleState.target && currentClean.length > 0) {
            document.getElementById('usSlot').classList.add("correct");
            if(navigator.vibrate) navigator.vibrate(100);
        } else {
            document.getElementById('usSlot').classList.remove("correct");
        }
    }

    function renderMemoryGame() {
        const memLayout = document.getElementById('memoryLayout');
        const all = document.querySelectorAll('.card > div:not(.timer-container):not(.explosion-popup):not(.flash-overlay):not(.score-badge)');
        all.forEach(e => e.style.display = 'none');
        memLayout.style.display = 'flex';
        memLayout.innerHTML = '<div class="mem-stats"><span>‚ù§Ô∏è Moves: <span id="memMoves">20</span></span></div>';
        memoryMoves = 20;
        let subset = currentItems.slice(0, 6);
        let deck = [];
        subset.forEach((item, idx) => {
            deck.push({ id: idx, content: item["Korean/Question"] });
            deck.push({ id: idx, content: item["English/Answer"] });
        });
        deck.sort(() => Math.random() - 0.5);
        deck.forEach(card => {
            let el = document.createElement('div');
            el.className = 'mem-card';
            el.innerHTML = `<div class="mem-inner"><div class="mem-face mem-front">?</div><div class="mem-face mem-back">${card.content}</div></div>`;
            el.onclick = () => flipCard(el, card);
            memLayout.appendChild(el);
        });
        memoryFlipped = [];
    }

    function flipCard(el, card) {
        if (memoryMoves <= 0 || el.classList.contains('flipped') || memoryFlipped.length >= 2) return;
        el.classList.add('flipped');
        memoryFlipped.push({ el, card });
        if (memoryFlipped.length === 2) {
            memoryMoves--;
            document.getElementById('memMoves').innerText = memoryMoves;
            const [c1, c2] = memoryFlipped;
            if (c1.card.id === c2.card.id) {
                setTimeout(() => { c1.el.classList.add('matched'); c2.el.classList.add('matched'); memoryFlipped=[]; }, 500);
            } else {
                setTimeout(() => { c1.el.classList.remove('flipped'); c2.el.classList.remove('flipped'); memoryFlipped=[]; }, 1000);
            }
            if (memoryMoves === 0) alert("Game Over!");
        }
    }

    function startTimer(duration, callback) {
        const bar = document.getElementById('timerBar');
        const cont = document.getElementById('gameTimer');
        cont.classList.remove('urgent');
        bar.style.transition = 'none'; bar.style.width = '100%';
        setTimeout(() => { 
            bar.style.transition = `width ${duration/1000}s linear`; 
            bar.style.width = '0%'; 
        }, 50);
        setTimeout(() => { cont.classList.add('urgent'); }, duration * 0.7);
        clearTimeout(timerId);
        timerId = setTimeout(callback, duration);
    }
    
    function speakText() {
        const item = currentItems[currentIndex];
        const u = new SpeechSynthesisUtterance(item["English/Answer"]);
        u.lang = 'en-US'; u.rate = 0.9; window.speechSynthesis.speak(u);
    }
    
    function nextSlide() { 
        if (currentIndex < currentItems.length - 1) { 
            currentIndex++; 
            renderSlide(); 
        } else {
            alert(`Game Over! üéâ\nCorrect: ${scoreCorrect}\nWrong: ${scoreWrong}`);
        }
    }
    function prevSlide() { if (currentIndex > 0) { currentIndex--; renderSlide(); } }
    
    function initTouchEvents() {
        let ts=0; const s=document.getElementById('touchStage');
        s.addEventListener('touchstart',e=>{ts=e.changedTouches[0].screenX},{passive:true});
        s.addEventListener('touchend',e=>{let te=e.changedTouches[0].screenX; if(te<ts-60)nextSlide(); if(te>ts+60)prevSlide();},{passive:true});
    }
    document.addEventListener('keydown', e => {
        if(e.key==="ArrowRight") nextSlide(); if(e.key==="ArrowLeft") prevSlide();
        if(e.key===" " && ['looksay','speed','blanks'].includes(currentMode)) toggleAnswer();
    });
</script>
</body>
</html>