<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pattern Master Class</title>
    <style>
        /* --- ê¸°ë³¸ ì„¤ì • --- */
        body {
            font-family: 'Pretendard', 'Malgun Gothic', sans-serif;
            background-color: #f0f2f5; margin: 0; padding: 0;
            height: 100vh; display: flex; flex-direction: column;
            overflow: hidden; user-select: none; -webkit-user-select: none;
        }

        /* --- í—¤ë” --- */
        header {
            background-color: #2c3e50; padding: 10px 20px;
            display: flex; align-items: center; justify-content: space-between;
            height: 60px; flex-shrink: 0; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 100;
        }
        .logo { font-size: 18px; font-weight: bold; color: #ecf0f1; display: flex; align-items: center; gap: 8px; }
        .menu-group { display: flex; gap: 8px; align-items: center; }

        select {
            background-color: #34495e; color: white; border: 1px solid #5d6d7e;
            padding: 8px 10px; border-radius: 8px; font-size: 14px;
            outline: none; font-weight: bold; cursor: pointer;
            width: auto; max-width: 300px; min-width: 100px;
            text-overflow: ellipsis; white-space: nowrap; overflow: hidden;
            transition: width 0.2s ease;
        }

        /* --- ë©”ì¸ ìŠ¤í…Œì´ì§€ --- */
        .stage {
            flex: 1; display: flex; justify-content: center; align-items: center;
            position: relative; padding: 20px; width: 100%; box-sizing: border-box;
        }
        .card {
            background: white; width: 100%; max-width: 900px; height: 100%; max-height: 600px;
            border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; overflow: hidden; position: relative;
        }

        /* =========================================
           ë ˆì´ì•„ì›ƒ 1: Look & Say / Blanks / Speed
           (ìƒë‹¨ 2/3 + í•˜ë‹¨ 1/3 êµ¬ì¡°)
           ========================================= */
        #lookSayLayout {
            display: flex; flex-direction: column; height: 100%; width: 100%;
        }
        /* ìƒë‹¨ 2/3: ë¬¸ì œ í‘œì‹œ ì˜ì—­ */
        .ls-upper {
            flex: 2; display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 20px; border-bottom: 1px solid #f0f0f0; overflow: hidden; text-align: center;
        }
        /* í•˜ë‹¨ 1/3: ì •ë‹µ ë°•ìŠ¤ ì˜ì—­ */
        .ls-lower {
            flex: 1; display: flex; justify-content: center; align-items: center;
            padding: 20px; background-color: #fafafa;
        }

        /* ì½˜í…ì¸  ìŠ¤íƒ€ì¼ */
        .q-text { font-size: 36px; font-weight: 800; color: #2c3e50; line-height: 1.4; word-break: keep-all; }
        .q-image { max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 10px; display: none; }
        .q-emoji { font-size: 140px; line-height: 1; display: none; animation: pop 0.3s; }
        .blank-text { font-size: 32px; font-weight: bold; color: #2c3e50; line-height: 1.6; display: none; }

        /* ì •ë‹µ í™•ì¸ ë°•ìŠ¤ */
        .answer-box {
            width: 90%; height: 70%; border-radius: 15px; font-weight: bold; font-size: 24px;
            cursor: pointer; transition: all 0.3s; display: flex; justify-content: center; align-items: center; text-align: center;
            background-color: white; color: #95a5a6; border: 2px dashed #bdc3c7;
        }
        .answer-box.visible {
            background-color: #3498db; color: white; border: 2px solid #3498db;
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.4); transform: translateY(-5px);
        }

        /* =========================================
           ë ˆì´ì•„ì›ƒ 2: Unscramble / Dictation
           (ìƒë‹¨ - ì¤‘ë‹¨ - í•˜ë‹¨ 3ë¶„í•  êµ¬ì¡°)
           ========================================= */
        #unscrambleLayout {
            display: none; flex-direction: column; height: 100%; width: 100%;
        }
        /* ìƒë‹¨: ì§ˆë¬¸(í•œê¸€) or ë“£ê¸° ë²„íŠ¼ */
        .us-top {
            flex: 1; display: flex; justify-content: center; align-items: center;
            padding: 10px 20px; border-bottom: 1px solid #eee; background: #fff;
        }
        .us-top .q-text { font-size: 28px; }

        /* ì¤‘ë‹¨: ì •ë‹µ ìŠ¬ë¡¯ */
        .us-mid {
            flex: 1.2; background: #f0f4f8; padding: 20px;
            display: flex; flex-wrap: wrap; align-content: center; justify-content: center; gap: 8px;
            overflow-y: auto; transition: background 0.3s;
        }
        .us-mid.correct { background: #e3f9e5; box-shadow: inset 0 0 20px rgba(46, 204, 113, 0.2); }

        /* í•˜ë‹¨: ë‹¨ì–´ ë¸”ë¡ í’€ */
        .us-bot {
            flex: 1; padding: 20px; background: white; border-top: 1px solid #eee;
            display: flex; flex-wrap: wrap; justify-content: center; align-content: center; gap: 10px;
        }

        /* â˜… ë‹¨ì–´ ë¸”ë¡ (ì‘ê³  ê¹”ë”í•˜ê²Œ ìˆ˜ì •ë¨) â˜… */
        .word-block {
            background: white; border: 2px solid #3498db; color: #2c3e50;
            padding: 8px 16px; /* íŒ¨ë”© ì¶•ì†Œ */
            border-radius: 8px; /* ë‘¥ê·¼ ì‚¬ê°í˜• */
            font-size: 18px; font-weight: bold;
            cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.1s, background 0.1s;
            display: flex; align-items: center; justify-content: center; text-align: center;
        }
        .word-block:active { transform: scale(0.95); }
        .word-block.used { opacity: 0; pointer-events: none; width: 0; padding: 0; margin: 0; border: 0; overflow: hidden; }
        .us-mid .word-block { background: #3498db; color: white; border-color: #3498db; box-shadow: none; }

        /* ë“£ê¸° ë²„íŠ¼ (Dictationìš©) */
        .listen-btn {
            background: #f1c40f; color: #2c3e50; border: none; padding: 10px 30px; border-radius: 50px;
            font-size: 22px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s; display: none; align-items: center; gap: 10px;
        }
        .listen-btn:active { transform: scale(0.95); }

        /* Speed Game Timer */
        .timer-bar-bg { position: absolute; top: 0; left: 0; width: 100%; height: 6px; background: #eee; display: none;}
        .timer-bar { height: 100%; background: #e74c3c; width: 100%; transition: width 1s linear; }

        /* ë„¤ë¹„ê²Œì´ì…˜ */
        .nav-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.8); border: 1px solid #ddd; width: 60px; height: 60px; border-radius: 50%; font-size: 28px; cursor: pointer; color: #2c3e50; box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 20; display: flex; justify-content: center; align-items: center; }
        .nav-prev { left: 10px; } .nav-next { right: 10px; }
        .progress-bar { position: absolute; bottom: 15px; font-size: 14px; color: #95a5a6; font-weight: bold; left: 50%; transform: translateX(-50%); }

        @media (max-width: 768px) {
            .q-text { font-size: 26px; }
            .us-top .q-text { font-size: 20px; }
            .word-block { font-size: 16px; padding: 6px 12px; }
            .card { height: 100%; border-radius: 0; } 
            .stage { padding: 0; } .logo span { display: none; }
            select { max-width: 150px; }
        }
    </style>
</head>
<body>

<header>
    <div class="logo">ğŸ“ <span>Pattern Master</span></div>
    <div class="menu-group">
        <select id="bookSel" onchange="updatePatterns(); resizeSelect(this)"></select>
        <select id="patSel" onchange="resetActivity(); resizeSelect(this)"></select>
        <select id="actSel" onchange="resetActivity(); resizeSelect(this)">
            <option value="looksay">1. Look & Say</option>
            <option value="unscramble">2. Unscramble</option>
            <option value="dictation">3. Block Dictation</option>
            <option value="blanks">4. Pattern Blanks</option>
            <option value="speed">5. Speed Game</option>
        </select>
    </div>
</header>

<div class="stage" id="touchStage">
    <button class="nav-btn nav-prev" onclick="prevSlide()">â®</button>
    <button class="nav-btn nav-next" onclick="nextSlide()">â¯</button>

    <div class="card">
        <div id="speedTimer" class="timer-bar-bg"><div id="timerBar" class="timer-bar"></div></div>

        <div id="lookSayLayout">
            <div class="ls-upper">
                <div id="qText" class="q-text">Loading...</div>
                <div id="blankText" class="blank-text"></div>
                <img id="qImg" class="q-image" src="" alt="Question">
                <div id="qEmoji" class="q-emoji"></div>
            </div>
            <div class="ls-lower">
                <div class="answer-box" id="aBox" onclick="toggleAnswer()">
                    ğŸ‘† Tap to check answer
                </div>
            </div>
        </div>

        <div id="unscrambleLayout">
            <div class="us-top">
                <div id="usText" class="q-text">Question</div>
                <button id="listenBtn" class="listen-btn" onclick="speakText()">ğŸ”Š Listen & Build</button>
            </div>
            <div id="usSlot" class="us-mid"></div>
            <div id="usPool" class="us-bot"></div>
        </div>
    </div>

    <div class="progress-bar" id="progress">1 / 10</div>
</div>

<script src="data.js"></script>
<script>
    function resizeSelect(sel) {
        let tempSpan = document.createElement("span");
        tempSpan.style.visibility = "hidden"; tempSpan.style.position = "absolute"; 
        tempSpan.style.fontSize = "14px"; tempSpan.style.fontWeight = "bold"; tempSpan.innerText = sel.options[sel.selectedIndex].text;
        document.body.appendChild(tempSpan);
        sel.style.width = (tempSpan.offsetWidth + 45) + "px";
        document.body.removeChild(tempSpan);
    }

    let currentItems = [];
    let currentIndex = 0;
    let currentMode = "looksay";
    let timerInterval = null; 
    let unscrambleState = { target: "", selected: [] };

    window.onload = function() {
        if (typeof bookData === 'undefined') { alert("data.js ì—†ìŒ"); return; }
        initBookMenu();
        initTouchEvents();
        resizeSelect(document.getElementById('actSel'));
    };

    function initBookMenu() {
        const bookSel = document.getElementById('bookSel');
        Object.keys(bookData).forEach(book => bookSel.innerHTML += `<option value="${book}">${book}</option>`);
        updatePatterns(); resizeSelect(bookSel);
    }

    function updatePatterns() {
        const bookName = document.getElementById('bookSel').value;
        const patSel = document.getElementById('patSel');
        const items = bookData[bookName];
        const pSet = new Set(items.map(d => d["Pattern #"]));
        patSel.innerHTML = "";
        pSet.forEach(p => {
            const name = items.find(d => d["Pattern #"] == p)["Pattern Name"];
            patSel.innerHTML += `<option value="${p}">${p}. ${name}</option>`;
        });
        resizeSelect(patSel);
        resetActivity();
    }

    function resetActivity() {
        const bookName = document.getElementById('bookSel').value;
        const pNum = parseInt(document.getElementById('patSel').value);
        currentMode = document.getElementById('actSel').value;
        
        const allItems = bookData[bookName].filter(d => d["Pattern #"] === pNum);
        
        // ë°ì´í„° í•„í„°ë§: ë¸”ë¡í˜• ê²Œì„ì€ Unscramble ë°ì´í„° ìš°ì„ 
        if (currentMode === 'unscramble' || currentMode === 'dictation') {
            currentItems = allItems.filter(d => d.Section === "Unscramble");
            if (!currentItems.length) currentItems = allItems.filter(d => d.Section === "Speaking II");
        } else {
            currentItems = allItems.filter(d => d.Section === "Speaking II");
            if (!currentItems.length) currentItems = allItems.filter(d => d.Section === "Unscramble");
        }

        currentIndex = 0;
        clearInterval(timerInterval);
        renderSlide();
    }

    function renderSlide() {
        if (currentItems.length === 0) return;
        const item = currentItems[currentIndex];
        
        const els = {
            lsLayout: document.getElementById('lookSayLayout'),
            usLayout: document.getElementById('unscrambleLayout'),
            qText: document.getElementById('qText'),
            blankText: document.getElementById('blankText'),
            qImg: document.getElementById('qImg'),
            qEmoji: document.getElementById('qEmoji'),
            aBox: document.getElementById('aBox'),
            usText: document.getElementById('usText'),
            listenBtn: document.getElementById('listenBtn'),
            timer: document.getElementById('speedTimer'),
            progress: document.getElementById('progress')
        };

        // ì´ˆê¸°í™”
        els.lsLayout.style.display = 'none';
        els.usLayout.style.display = 'none';
        els.timer.style.display = 'none';
        
        // Look & Say ìš”ì†Œ ì´ˆê¸°í™”
        els.qText.style.display = 'none';
        els.blankText.style.display = 'none';
        els.qImg.style.display = 'none';
        els.qEmoji.style.display = 'none';
        els.aBox.className = "answer-box";
        els.aBox.innerText = "ğŸ‘† Tap to check answer";
        els.progress.innerText = `${currentIndex + 1} / ${currentItems.length}`;

        // ì´ë¯¸ì§€ ì²´í¬
        let hasImage = false;
        const imageVal = item["Image"] ? item["Image"].trim() : "";
        
        if (imageVal !== "") {
            if (imageVal.includes('.') || imageVal.includes('/')) {
                els.qImg.src = "images/" + imageVal;
                if(currentMode !== 'dictation') hasImage = true; // ë”•í…Œì´ì…˜ì¼ë• ì´ë¯¸ì§€ ì•ˆì”€
            } else {
                els.qEmoji.innerText = imageVal;
                if(currentMode !== 'dictation') hasImage = true;
            }
        }

        // ëª¨ë“œë³„ ë Œë”ë§
        switch(currentMode) {
            case 'looksay':
                els.lsLayout.style.display = 'flex';
                if (hasImage) {
                    if(els.qImg.src) els.qImg.style.display = 'block';
                    else els.qEmoji.style.display = 'block';
                } else {
                    els.qText.innerText = item["Korean/Question"];
                    els.qText.style.display = 'block';
                }
                break;

            case 'blanks':
                els.lsLayout.style.display = 'flex';
                let patName = item["Pattern Name"].replace(/[\.\~\?\[\]]/g, "").trim();
                let sentence = item["English/Answer"];
                let regex = new RegExp(patName, "i");
                let masked = sentence.replace(regex, "_______");
                if (masked === sentence) {
                    let parts = sentence.split(" ");
                    if(parts.length > 1) { parts[0] = "____"; parts[1] = "____"; masked = parts.join(" "); }
                }
                els.blankText.innerHTML = masked;
                els.blankText.style.display = 'block';
                break;

            case 'speed':
                els.lsLayout.style.display = 'flex';
                els.timer.style.display = 'block';
                if (hasImage) {
                    if(els.qImg.src) els.qImg.style.display = 'block';
                    else els.qEmoji.style.display = 'block';
                } else {
                    els.qText.innerText = item["Korean/Question"];
                    els.qText.style.display = 'block';
                }
                startTimer();
                break;

            case 'unscramble':
                els.usLayout.style.display = 'flex';
                els.usText.style.display = 'block';
                els.listenBtn.style.display = 'none';
                els.usText.innerText = item["Korean/Question"];
                initUnscramble(item);
                break;

            case 'dictation':
                els.usLayout.style.display = 'flex';
                els.usText.style.display = 'none'; // í…ìŠ¤íŠ¸ ìˆ¨ê¹€
                els.listenBtn.style.display = 'flex'; // ë“£ê¸° ë²„íŠ¼ í‘œì‹œ
                initUnscramble(item);
                break;
        }
    }

    // --- ê¸°ëŠ¥ ë¡œì§ ---

    function toggleAnswer() {
        const item = currentItems[currentIndex];
        const aBox = document.getElementById('aBox');
        if (aBox.classList.contains('visible')) {
            aBox.classList.remove('visible'); aBox.innerText = "ğŸ‘† Tap to check answer";
        } else {
            aBox.classList.add('visible'); aBox.innerText = item["English/Answer"];
            if(currentMode === 'speed') clearInterval(timerInterval);
        }
    }

    function initUnscramble(item) {
        const usSlot = document.getElementById('usSlot');
        const usPool = document.getElementById('usPool');
        usSlot.innerHTML = ""; usPool.innerHTML = ""; usSlot.className = "us-mid";
        
        unscrambleState.target = item["English/Answer"].replace(/[^a-zA-Z0-9]/g, "").toLowerCase();
        
        let raw = item["Scrambled"] || item["English/Answer"];
        let words = raw.includes("/") ? raw.split("/") : raw.split(" ");
        words = words.map(w=>w.trim()).sort(()=>Math.random()-0.5);

        words.forEach((w) => {
            let btn = document.createElement("div");
            btn.className = "word-block"; btn.innerText = w;
            btn.onclick = () => {
                btn.classList.add("used");
                let slotBtn = document.createElement("div");
                slotBtn.className = "word-block"; slotBtn.innerText = w;
                slotBtn.onclick = () => { slotBtn.remove(); btn.classList.remove("used"); checkUnscramble(); };
                usSlot.appendChild(slotBtn);
                checkUnscramble();
            };
            usPool.appendChild(btn);
        });
    }

    function checkUnscramble() {
        const currentWords = Array.from(document.querySelectorAll("#usSlot .word-block")).map(el=>el.innerText).join("");
        const currentClean = currentWords.replace(/[^a-zA-Z0-9]/g, "").toLowerCase();
        
        if (currentClean === unscrambleState.target && currentClean.length > 0) {
            document.getElementById('usSlot').classList.add("correct");
            if(navigator.vibrate) navigator.vibrate(50);
        } else {
            document.getElementById('usSlot').classList.remove("correct");
        }
    }

    function speakText() {
        const item = currentItems[currentIndex];
        const utterance = new SpeechSynthesisUtterance(item["English/Answer"]);
        utterance.lang = 'en-US'; utterance.rate = 0.9;
        window.speechSynthesis.speak(utterance);
    }

    function startTimer() {
        const bar = document.getElementById('timerBar');
        bar.style.transition = 'none'; bar.style.width = '100%';
        setTimeout(() => { bar.style.transition = 'width 5s linear'; bar.style.width = '0%'; }, 50);
        clearInterval(timerInterval);
        timerInterval = setTimeout(() => {
            const aBox = document.getElementById('aBox');
            if (!aBox.classList.contains('visible')) toggleAnswer();
        }, 5000);
    }

    function nextSlide() { if (currentIndex < currentItems.length - 1) { currentIndex++; renderSlide(); } }
    function prevSlide() { if (currentIndex > 0) { currentIndex--; renderSlide(); } }

    function initTouchEvents() {
        let ts = 0;
        const stage = document.getElementById('touchStage');
        stage.addEventListener('touchstart', e => { ts = e.changedTouches[0].screenX; }, {passive: true});
        stage.addEventListener('touchend', e => { 
            let te = e.changedTouches[0].screenX; 
            if (te < ts - 60) nextSlide(); if (te > ts + 60) prevSlide();
        }, {passive: true});
    }

    document.addEventListener('keydown', (e) => {
        if (e.key === "ArrowRight") nextSlide();
        if (e.key === "ArrowLeft") prevSlide();
        if (e.key === " ") toggleAnswer();
    });
</script>
</body>
</html>